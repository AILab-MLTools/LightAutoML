name: Mirror repo

on: [push]

jobs:
  mirror:
    runs-on: "ubuntu-latest"
    steps:
      - name: Configure Private Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DESITNATION_REPO_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Push mirror
        env:
          SOURCE_REPO: "https://github.com/${{ github.repository }}.git"
          DESTINATION_REPO: "${{ secrets.DESTINATION_REPO }}"
          BASE_REPO: "https://github.com/${{ github.repository }}"
        run: |
          git clone "$SOURCE_REPO" && cd `basename "$BASE_REPO"`
          cd "$REPO_NAME"

          git config --global user.name "${{ github.actor }}"
          git config --global user.email "bot@example.com"

          git remote set-url --push origin "$DESTINATION_REPO"
          git push origin ${CI_COMMIT_REF_NAME} --force
